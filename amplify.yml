version: 1
backend:
  phases:
    build:
      commands:
        - '# Execute backend build commands only if backend files changed'
        - 'if [ "$(git diff --name-only $AMPLIFY_PREV_COMMIT $AMPLIFY_HEAD_COMMIT | grep -E "^amplify/(backend|api|function|auth)/")" != "" ]; then'
        - '  echo "Backend changes detected, building backend"'
        - '  amplify push --yes'
        - 'else'
        - '  echo "No backend changes detected, skipping backend build"'
        - 'fi'
frontend:
  phases:
    preBuild:
      commands:
        - echo "Node version $(node -v)"
        - '# Install dependencies only if package files changed or node_modules is missing'
        - 'if [ "$(git diff --name-only $AMPLIFY_PREV_COMMIT $AMPLIFY_HEAD_COMMIT | grep -E "package(-lock)?.json$")" != "" ] || [ ! -d "node_modules" ]; then'
        - '  echo "Installing dependencies"'
        - '  npm ci'
        - 'else'
        - '  echo "Using cached node_modules"'
        - 'fi'
    build:
      commands:
        - '# Determine changed areas'
        - 'FRONTEND_CHANGED=$(git diff --name-only $AMPLIFY_PREV_COMMIT $AMPLIFY_HEAD_COMMIT | grep -v "^amplify/" | wc -l)'
        - 'if [ "$FRONTEND_CHANGED" -gt "0" ] || [ "$AMPLIFY_JOB_NAME" = "release" ]; then'
        - '  echo "Frontend changes detected, running full build"'
        - '  npm run build'
        - 'else'
        - '  echo "Only backend changes detected, running minimal frontend build"'
        - '  SKIP_PREFLIGHT_CHECK=true npm run build'
        - 'fi'
  artifacts:
    baseDirectory: build # or dist, .next, etc. depending on your framework
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .npm/**/*
      - .cache/**/* 
      - .next/cache/**/* # For Next.js projects
      - build/**/* # Cache build artifacts when possible
test:
  phases:
    preTest:
      commands:
        - '# Run tests only if relevant files changed'
        - 'if [ "$(git diff --name-only $AMPLIFY_PREV_COMMIT $AMPLIFY_HEAD_COMMIT | grep -E "src/|tests/|__tests__/")" != "" ]; then'
        - '  echo "Changes detected in testable files, running tests"'
        - '  npm ci'
        - 'else'
        - '  echo "No changes to testable files, skipping tests"'
        - '  exit 0'
        - 'fi'
    test:
      commands:
        - npm test -- --watchAll=false --passWithNoTests
  artifacts:
    baseDirectory: coverage
    files:
      - '**/*'