version: 1
backend:
  phases:
    build:
      commands:
        - echo "Starting backend build"
        - '# Execute backend build commands only if backend files changed or on initial deployments'
        - |
          if [ "$AWS_COMMIT_ID" == "" ] || [ -n "$(find amplify -name "*.ts" -o -name "*.js" -o -name "*.json" -mtime -1)" ]; then
            echo "Backend changes detected, building backend"
            amplify push --yes
          else
            echo "No backend changes detected, skipping backend build"
          fi
frontend:
  phases:
    preBuild:
      commands:
        - echo "Node version $(node -v)"
        - '# Install dependencies only if package files changed or node_modules is missing'
        - 'if [ ! -d "node_modules" ] || [ -n "$(find . -name "package*.json" -mtime -1)" ]; then'
        - '  echo "Installing dependencies"'
        - '  npm ci'
        - 'else'
        - '  echo "Using cached node_modules"'
        - 'fi'
    build:
      commands:
        - echo "Running frontend build"
        - npm run build
  artifacts:
    baseDirectory: build # or dist, .next, etc. depending on your framework
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .npm/**/*
      - .cache/**/* 
      - .next/cache/**/* # For Next.js projects
      - build/**/* # Cache build artifacts when possible
test:
  phases:
    preTest:
      commands:
        - echo "Skipping tests unless explicitly configured"
    test:
      commands:
        - echo "No tests run by default"